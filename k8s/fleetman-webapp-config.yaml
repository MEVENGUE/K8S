apiVersion: v1
kind: ConfigMap
metadata:
  name: fleetman-webapp-nginx
  namespace: fleetman
data:
  nginx.conf: |
    user  nginx;
    worker_processes  auto;
    events { worker_connections 1024; }
    http {
      include       mime.types;
      default_type  application/octet-stream;
      resolver kube-dns.kube-system.svc.cluster.local valid=10s;
      sendfile        on;
      keepalive_timeout  65;
      
      # Timeouts globaux pour éviter les 504
      proxy_connect_timeout   60s;
      proxy_send_timeout      60s;
      proxy_read_timeout      60s;
      
      server {
        listen 80;
        server_name _;
        
        # History service - véhicules avec historique (doit être avant /api/vehicles/)
        location ~ ^/api/vehicles/(.+)/(history|positions)$ {
          proxy_pass http://fleetman-history-service.fleetman.svc.cluster.local:8080/api/vehicles/$1/$2;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          add_header Access-Control-Allow-Origin * always;
          add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
          add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        }
        
        # Position Tracker - véhicules (LISTE ET POSITIONS)
        location /api/vehicles/ {
          proxy_pass http://fleetman-position-tracker.fleetman.svc.cluster.local:8080/vehicles/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
          add_header Access-Control-Allow-Origin * always;
          add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
          add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        }
        
        # Toutes les autres routes API -> API Gateway
        location /api/ {
          proxy_pass http://fleetman-api-gateway.fleetman.svc.cluster.local:8080/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_http_version 1.1;
          proxy_set_header Connection "";
        }
        
        # Angular app
        location / {
          root /usr/share/nginx/html;
          try_files $uri $uri/ /index.html;
        }
      }
    }
